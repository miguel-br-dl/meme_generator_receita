<section class="generator-grid">
  <p-card header="Configuração do Meme">
    <p class="panel-text">Selecione um template e personalize os campos obrigatórios.</p>

    <p *ngIf="loading" class="feedback">Carregando templates...</p>
    <p *ngIf="loadError" class="feedback error">{{ loadError }}</p>

    <form [formGroup]="form" class="editor-form" *ngIf="!loading && !loadError">
      <label for="templateId">Template</label>
      <p-dropdown
        inputId="templateId"
        formControlName="templateId"
        [options]="templates"
        optionLabel="name"
        optionValue="id"
        placeholder="Selecione um template"
        [showClear]="false"
        styleClass="w-full"
      ></p-dropdown>

      <section class="template-meta" *ngIf="selectedTemplate as tpl" [class.collapsed]="templateMetaCollapsed">
        <div class="template-meta-header">
          <p class="template-meta-title">Detalhes do template</p>
          <button
            type="button"
            class="template-meta-toggle"
            (click)="toggleTemplateMeta()"
            [attr.aria-expanded]="!templateMetaCollapsed"
            [attr.aria-label]="templateMetaCollapsed ? 'Expandir detalhes do template' : 'Minimizar detalhes do template'"
          >
            <span class="toggle-diamond" aria-hidden="true"></span>
            <span>{{ templateMetaCollapsed ? '+' : '-' }}</span>
          </button>
        </div>

        <div class="template-meta-content" *ngIf="!templateMetaCollapsed">
          <p class="template-description">{{ tpl.description }}</p>

          <img
            *ngIf="tpl.assets.preview"
            class="template-thumb"
            [src]="tpl.assets.preview"
            [alt]="'Preview de ' + tpl.name"
          />
        </div>
      </section>

      <ng-container *ngFor="let field of fields; trackBy: trackByKey">
        <label [for]="field.key">{{ field.label }}</label>

        <input
          *ngIf="field.type === 'text'"
          pInputText
          [id]="field.key"
          [placeholder]="field.placeholder || ''"
          [formControlName]="field.key"
          [attr.maxlength]="field.maxLength || null"
        />

        <textarea
          *ngIf="field.type === 'textarea'"
          pInputTextarea
          [id]="field.key"
          [placeholder]="field.placeholder || ''"
          [formControlName]="field.key"
          [attr.maxlength]="field.maxLength || null"
          [autoResize]="true"
          rows="3"
        ></textarea>

        <p-dropdown
          *ngIf="field.type === 'select'"
          [inputId]="field.key"
          [formControlName]="field.key"
          [options]="field.options || []"
          optionLabel="label"
          optionValue="value"
          [placeholder]="field.placeholder || 'Selecione uma opção'"
          [showClear]="false"
          styleClass="w-full"
        ></p-dropdown>

        <div *ngIf="field.type === 'image'" class="image-field">
          <input
            type="file"
            [id]="field.key"
            accept="image/*"
            (change)="onImageSelected(field.key, $event)"
          />
          <p class="image-field-name" *ngIf="imageFieldNames[field.key]">{{ imageFieldNames[field.key] }}</p>
          <p class="image-field-name" *ngIf="!imageFieldNames[field.key]">Nenhuma imagem selecionada.</p>
        </div>
      </ng-container>
    </form>
  </p-card>

  <p-card header="Pré-visualização">
    <app-meme-preview [template]="selectedTemplate" [values]="previewValues"></app-meme-preview>

    <div class="preview-actions">
      <button type="button" class="download-button" (click)="downloadPreviewImage()" [disabled]="!selectedTemplate || downloading">
        {{ downloading ? 'Gerando imagem...' : 'Baixar imagem' }}
      </button>
      <p *ngIf="downloadError" class="feedback error">{{ downloadError }}</p>
    </div>
  </p-card>
</section>
